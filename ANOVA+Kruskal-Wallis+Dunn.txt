library(dplyr)
library(ggplot2)
library(tidyr)
library(RColorBrewer)
library(FSA)      # 用于Dunn检验
library(PMCMRplus) # 用于Nemenyi检验
library(ggpubr)    # 用于添加显著性标记

# 读取数据
ext_data <- read.csv("global+china_env.csv", row.names = 1, check.names = F)
colnames(ext_data)
# 计算每个站点的平均相对丰度，并增加三个基因的相对丰度列
ext_df = ext_data %>%
  group_by(Biome, site) %>%
  dplyr::summarise(
    Relative_abundance = mean(Relative_abundance, na.rm = TRUE),
    Richness = mean(Richness, na.rm = TRUE),
    pd = mean(pd, na.rm = TRUE)
  )

# 计算每个生物群系的均值和标准误
se <- function(x, na.rm = FALSE) {
  sd(x, na.rm = na.rm) / sqrt(sum(!is.na(x)))
}

daaa <- ext_df %>%
  pivot_longer(cols = c(Relative_abundance, Richness,pd), 
               names_to = "Gene", values_to = "Relative_abundance_df") %>%
  group_by(Biome, Gene) %>%
  dplyr::summarise(
    Relative_abundance_mean = mean(Relative_abundance_df, na.rm = TRUE),
    Relative_abundance_SE = se(Relative_abundance_df, na.rm = TRUE)
  )


# 恢复原始代码中颜色的详细定义
#colors <- brewer.pal(5,"Paired") # 选择一个包含足够颜色数的调色板
#colors <- colorRampPalette(colors)(25) # 生成25种渐变色
# 生成不同植被类型的色系
cropland_colors <- brewer.pal(5, "Blues")   
forest_colors <- brewer.pal(7, "Reds")   
grassland_colors <- brewer.pal(6, "Greens")
shrubland_colors <- brewer.pal(4, "Purples")
desert_colors <- brewer.pal(11, "PiYG")     

#desert_gradients <- colorRampPalette(desert_colors)(5)
# 分配每个 Biome 对应的颜色
# 分配每个 Biome 对应的颜色
colors <- c(
  "Alpine cropland" = cropland_colors[5],
  "Continental cropland" = cropland_colors[4],
  "Dry cropland" = cropland_colors[3],
  "Temperate cropland" = cropland_colors[2],
  "Tropical cropland" = cropland_colors[1],
  
  
  "Alpine forest" = forest_colors[5],
  "Continental forest" = forest_colors[4],
  "Dry forest" = forest_colors[3],
  "Temperate forest" = forest_colors[2],
  "Tropical forest" = forest_colors[1],
  
  "Alpine grassland"= grassland_colors[6],
  "Continental grassland" = grassland_colors[5],
  "Dry grassland" = grassland_colors[4],
  "Temperate grassland" = grassland_colors[3],
  "Tropical grassland" = grassland_colors[2],
  "Polar grassland" = grassland_colors[1],
  
  "Continental shrubland" = shrubland_colors[3],
  "Dry shrubland" = shrubland_colors[2],
  "Temperate shrubland" = shrubland_colors[1],
  
  "Alpine desert" = desert_colors[1],
  "Continental desert" = desert_colors[2],
  "Dry desert" = desert_colors[3],
  "Temperate desert" = desert_colors[4]
)

# 将 Biome 重新排序
daaa$Biome <- factor(daaa$Biome, levels = names(colors))

# 分别对每个基因进行 ANOVA 并提取 P 值和 F 值
anova_results <- ext_df %>%
  pivot_longer(cols = c(Relative_abundance, Richness,pd), 
               names_to = "Gene", values_to = "Relative_abundance_df") %>%
  group_by(Gene) %>%
  do({
    aov_result <- aov(Relative_abundance_df ~ Biome, data = .)
    summary_result <- summary(aov_result)
    p_value <- summary_result[[1]][["Pr(>F)"]][1]  # 提取P值
    f_value <- summary_result[[1]][["F value"]][1]  # 提取F值
    data.frame(Gene = unique(.$Gene), F_value = f_value, P_value = p_value)
  })
# 1. 执行Kruskal-Wallis检验
kw_results <- ext_df %>%
  pivot_longer(cols = c(Relative_abundance, Richness, pd), 
               names_to = "Gene", values_to = "Relative_abundance_df") %>%
  group_by(Gene) %>%
  do({
    kw_result <- kruskal.test(Relative_abundance_df ~ Biome, data = .)
    print(paste("原始H统计量:", kw_result$statistic))
    data.frame(
      Gene = unique(.$Gene),
      H_statistic = kw_result$statistic,
      P_value = kw_result$p.value
    )
  })

# 2. 对显著的结果进行Dunn多重比较
dunn_results <- ext_df %>%
  pivot_longer(cols = c(Relative_abundance, Richness, pd), 
               names_to = "Gene", values_to = "Relative_abundance_df") %>%
  group_by(Gene) %>%
  do({
    if(kruskal.test(Relative_abundance_df ~ Biome, data = .)$p.value < 0.05) {
      dunnTest(Relative_abundance_df ~ Biome, data = ., method = "bh")$res
    } else {
      data.frame(Comparison = NA, Z = NA, P.unadj = NA, P.adj = NA)
    }
  })
dunn_results1 <- dunn_results %>%
  
  separate(Comparison, into = c("group1", "group2"), sep = " - ")


dunn_pd <- read.csv("dunn_ pd.csv", check.names = F)
# 假设sig_comparisons是Dunn检验结果，包含group1、group2和p.adj列
# 提取所有唯一组别
groups <- unique(c(dunn_Relative_abundance$group1, dunn_Relative_abundance$group2))
# 创建空矩阵
p_matrix <- matrix(NA, nrow = length(groups), ncol = length(groups), 
                   dimnames = list(groups, groups))
# 填充矩阵
for (i in 1:nrow(dunn_Relative_abundance)) {
  row_group <- dunn_Relative_abundance$group1[i]
  col_group <- dunn_Relative_abundance$group2[i]
  p_matrix[row_group, col_group] <- dunn_Relative_abundance$P.adj[i]
  p_matrix[col_group, row_group] <- dunn_Relative_abundance$P.adj[i]  # 对称填充
}
# 对角线设为1（自身比较的p值）

p_matrix[upper.tri(p_matrix, diag = FALSE)] <- 0

write.csv(p_matrix,"dunn_Relative_abundance_matrix.csv")
# 将ANOVA结果加入到图中
daaa$Gene <- factor(daaa$Gene, levels = c("Relative_abundance", "Richness", "pd"))
P <- ggplot(data=daaa, aes(x=Biome, y=Relative_abundance_mean, fill=Biome)) +
  scale_fill_manual(values = colors) +
  geom_bar(position=position_dodge(width = 0.8), stat="identity", colour="black", width = 0.6, size = 0.2) +
  geom_errorbar(aes(ymin=Relative_abundance_mean-Relative_abundance_SE, ymax=Relative_abundance_mean+Relative_abundance_SE),
                width=0.2, position=position_dodge(0.8), size = 0.2) +
  scale_y_continuous(
    limits = c(0, NA),  # 设置y轴的限制
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    panel.grid = element_blank(), 
    panel.border = element_rect(fill = NA, colour = 'black', size = 0.2), 
    panel.background = element_rect(fill = '#FFFFFF'),
    plot.title = element_text(size = 9, hjust = 0.5), 
    plot.subtitle = element_text(size = 9, hjust = 0.5), 
    axis.text = element_text(size = 9, color = 'black'), 
    axis.title = element_text(size = 9, color = 'black'),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.ticks = element_line(size = 0.2, color = "black"), 
    legend.position = "none"
  ) +
  labs(x = NULL, y = "Relative abundance") +
  facet_grid(Gene ~ ., scales = "free_y")  # 使用facet_grid分面绘制，确保基因相对丰度图严格垂直对齐

# 输出图形
print(P)
print(anova_results)
# 保存图像
ggsave("relative_abundance_genes_with_anova.pdf", plot = P, width = 180, height = 200, units = "mm")
